<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gravi-Tec Chat Demo</title>
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Source Sans Pro', sans-serif;
      background: #0f1316;
      color: #eee;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .gt-chat-container {
      width: 600px;
	  font-family: 'Source Sans Pro', sans-serif;
      background: #1b1f24;
      border: 3px solid #000;
      display: flex;
      flex-direction: column;
      height: 600px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.6);
      color: #ddd;
    }

    .gt-chat-header {
      background: linear-gradient(180deg, #3b75c3, #2858a8);
      color: white;
      font-weight: 700;
      padding: 14px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.12);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .gt-chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    .gt-chat-message-row {
      width: 100%;
      display: flex;
      margin-bottom: 4px;
    }

    .gt-chat-message-row.user {
      justify-content: flex-end;
    }

    .gt-chat-message-row.assistant {
      justify-content: flex-start;
    }

    .gt-chat-message {
      max-width: 80%;
      width: auto;
      background: #232933;
      color: #f0f0f0;
      padding: 10px 14px;
      border-radius: 8px;
      word-wrap: break-word;
      line-height: 1.4;
    }

    .gt-chat-message span {
      display: block;
      overflow-wrap: anywhere;
      word-break: break-word;
      margin: 0;
    }

    .gt-chat-message p {
      margin: 0;
      padding: 0;
    }

    .gt-chat-message pre,
    .gt-chat-message code {
      white-space: pre-wrap;
      word-break: break-word;
      overflow-wrap: anywhere;
    }

    .gt-chat-message.user {
      background: #2858a8;
      color: #fff;
    }

    .gt-chat-message.assistant {
      background: #232933;
      color: #f0f0f0;
    }

    .gt-chat-input {
      display: flex;
      gap: 10px;
      padding: 6px 12px;
      background: #1b1f24;
      border-top: 1px solid #333;
      align-items: flex-end;
    }

    .gt-chat-textarea-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .gt-chat-input-field {
      width: 100%;
      resize: none;
      border: none;
      border-radius: 6px;
      outline: none;
      background: #0f1316;
      color: #fff;
      font-family: inherit;
      font-size: 15px;
      line-height: 1.4;
      padding: 6px 12px;
      max-height: calc(1.4em * 5 + 12px);
      overflow-y: auto;
      box-sizing: border-box;
    }

	.gt-chat-input-field,
	.gt-chat-input-field:hover,
	.gt-chat-input-field:focus {
	  background-color: #0f1316 !important;  /* dark background */
	  color: #fff !important;               /* text color */
	  border: none !important;              /* remove any hover border */
	  box-shadow: none !important;          /* remove glow if applied by theme */
	}

    /* Button style */
    .gt-chat-btn-schild {
      position: relative;
      display: inline-block;
      transform: skewX(-2deg);
      border-radius: 10px;
      background: linear-gradient(180deg, #3b75c3, #2858a8);
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: 0 8px 24px rgba(0,0,0,0.5), 0 0 12px rgba(40,88,168,0.4);
      overflow: hidden;
      min-width: 140px;
      padding-right: 20px;
    }

    .gt-chat-btn-schild > a {
      display: block;
      padding: 14px 54px 14px 28px;
      transform: skewX(2deg);
      color: white;
      text-decoration: none;
      font-weight: 700;
      font-size: 16px;
      position: relative;
      z-index: 1;
      text-align: center;
    }

    .gt-chat-btn-schild .chip {
      position: absolute;
      right: 6px;
      top: 6px;
      bottom: 6px;
      width: 46px;
      transform: skewX(-2deg);
      border-radius: 8px;
      background: linear-gradient(180deg, #fff, #f4f7fc);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      border: 1px solid rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .gt-chat-btn-schild .chip span {
      display: inline-block;
      transform: skewX(12deg);
      font-size: 18px;
      color: #2858a8;
      font-weight: 900;
    }

    .gt-chat-btn-schild:hover {
      background: linear-gradient(180deg, #3b75c3, #3b75c3);
      box-shadow: 0 10px 30px rgba(0,0,0,0.5), 0 0 16px rgba(40,88,168,0.4);
    }

    /* Typing indicator */
    .gt-chat-typing {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 10px 14px;
      border-radius: 12px;
      background: #232933;
      align-self: flex-start;
      transform: skewX(-12deg);
    }

    .gt-chat-typing span {
      transform: skewX(12deg);
      display: flex;
      gap: 4px;
    }

    .gt-chat-dot {
      width: 8px;
      height: 8px;
      background: #3b75c3;
      border-radius: 50%;
      animation: bounce 1s infinite;
    }

    .gt-chat-dot:nth-child(2) { animation-delay: 0.2s; }
    .gt-chat-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }
  </style>
</head>
<body>

  <div class="gt-chat-container">
    <div class="gt-chat-header">Gravi-Tec Support Chat</div>
    <div class="gt-chat-messages" id="chat"></div>
    <div class="gt-chat-input">
      <div class="gt-chat-textarea-wrapper">
        <textarea
          id="chatbot-input"
          class="gt-chat-input-field"
          placeholder="Nachricht eingeben..."
          rows="1"
        ></textarea>
      </div>
      <div class="gt-chat-btn-schild" id="sendBtn" onclick="sendMessageStream()">
        <a href="#">Senden</a>
        <div class="chip"><span>âœŽ</span></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/lib/marked.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
  <script>
const STORAGE_KEY = "chat_session_ids";
const MAX_MESSAGES_IN_STORAGE = 5;

const chat = document.getElementById('chat');
const input = document.getElementById('chatbot-input');
const sessionID = "test_session_" + formatDateNow() + "_" + Math.random().toString(36).substr(2, 9);

let messages = [];
let isWaitingResponse = false;
let typingIndicator = null;
let greeted = false;

console.log("Session ID: ", sessionID);
saveSessionId(sessionID);

// Show greeting immediately since chat is always visible
addMessage('assistant', 'ðŸ‘‹ Hallo! Ich bin Ihr Gravi-Tec Berater. Wie kann ich Ihnen heute helfen?');
greeted = true;

function addMessage(role, content) {
  messages.push({ role, content, timestamp: Date.now() });

  const row = document.createElement('div');
  row.className = 'gt-chat-message-row ' + role;

  const msgDiv = document.createElement('div');
  msgDiv.className = 'gt-chat-message ' + role;

  const inner = document.createElement('span');

  const md = window.markdownit();
  let formattedContent = content
    .replace(/\\n/g, '\n')
    .replace(/\\t/g, '&nbsp;&nbsp;')
    .replace(/\\ /g, ' ');

  inner.innerHTML = marked.parse(formattedContent);

  msgDiv.appendChild(inner);
  row.appendChild(msgDiv);
  chat.appendChild(row);
  chat.scrollTop = chat.scrollHeight;
}

function showTyping() {
  typingIndicator = document.createElement('div');
  typingIndicator.className = 'gt-chat-typing';
  const inner = document.createElement('span');
  inner.innerHTML = '<div class="gt-chat-dot"></div><div class="gt-chat-dot"></div><div class="gt-chat-dot"></div>';
  typingIndicator.appendChild(inner);
  chat.appendChild(typingIndicator);
  chat.scrollTop = chat.scrollHeight;
}

function removeTyping() {
  if (typingIndicator) {
    chat.removeChild(typingIndicator);
    typingIndicator = null;
  }
}

function addStreamingBotMessage() {
  const row = document.createElement('div');
  row.className = 'gt-chat-message-row assistant';

  const msgDiv = document.createElement('div');
  msgDiv.className = 'gt-chat-message assistant';

  const inner = document.createElement('span');
  inner.innerHTML = '';

  msgDiv.appendChild(inner);
  row.appendChild(msgDiv);
  chat.appendChild(row);
  chat.scrollTop = chat.scrollHeight;

  return inner;
}

function appendToBotMessage(innerEl, textChunk) {
  if (!innerEl) return;
  innerEl._raw = (innerEl._raw || '') + textChunk;
  innerEl.innerHTML = marked.parse(innerEl._raw);
  chat.scrollTop = chat.scrollHeight;
}

async function sendMessageStream() {
  if (isWaitingResponse) return;

  let hasStartedStreaming = false;
  let botInnerEl = null;

  const inputEl = document.querySelector('.gt-chat-input-field');
  const text = inputEl.value.trim();
  if (!text) return;

  isWaitingResponse = true;
  const sendBtn = document.getElementById('sendBtn');
  sendBtn.style.pointerEvents = 'none';
  sendBtn.style.opacity = '0.6';

  addMessage('user', text);
  inputEl.value = '';
  showTyping();

  try {
    const requestBody = {
      session_id: sessionID,
      messages: messages
    };

    const backendURLstream = 'https://gravitec-faq-demo-backend.onrender.com/api/v1/chat/stream';
    // const backendURLstream = 'http://localhost:8000/api/v1/chat/stream';

    const res = await fetch(backendURLstream, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(requestBody)
    });

    if (!res.body) throw new Error('Streaming not supported');

    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';

    while (true) {
      const { value, done } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });
      const parts = buffer.split('\n\n');
      buffer = parts.pop();

      for (const part of parts) {
        if (!part.startsWith('data:')) continue;
        const json = JSON.parse(part.replace('data:', '').trim());

        if (json.type === 'token') {
          if (!hasStartedStreaming) {
            removeTyping();
            botInnerEl = addStreamingBotMessage();
            hasStartedStreaming = true;
          }
          appendToBotMessage(botInnerEl, json.text);
        }

        if (json.type === 'final') {
          messages.push({
            role: 'assistant',
            content: botInnerEl._raw,
            timestamp: Date.now()
          });
        }

        if (json.error) {
          appendToBotMessage(botInnerEl, '\n\nâš ï¸ ' + json.message);
        }
      }
    }
  } catch (e) {
    console.error(e);
    if (!botInnerEl) botInnerEl = addStreamingBotMessage();
    appendToBotMessage(botInnerEl, '\n\nâŒ Verbindung zum Server fehlgeschlagen.');
  } finally {
    isWaitingResponse = false;
    removeTyping();
    sendBtn.style.pointerEvents = 'auto';
    sendBtn.style.opacity = '1';
  }
}

input.addEventListener("keydown", (e) => {
  if (document.activeElement !== input) return;
  if (isWaitingResponse) return;

  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessageStream();
  }
});

// Auto-resize textarea
input.addEventListener('input', () => {
  input.style.height = 'auto';
  const lineHeight = parseInt(getComputedStyle(input).lineHeight);
  const maxHeight = lineHeight * 5 + 24;
  input.style.height = Math.min(input.scrollHeight, maxHeight) + 'px';
});

function formatDateNow() {
  const d = new Date(Date.now());
  const pad = n => String(n).padStart(2, '0');
  return (
    d.getFullYear() + '_' +
    pad(d.getMonth() + 1) + '_' +
    pad(d.getDate()) + '_' +
    pad(d.getHours()) + '_' +
    pad(d.getMinutes()) + '_' +
    pad(d.getSeconds())
  );
}

function saveSessionId(newSessionId) {
  let sessions = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
  sessions = sessions.filter(id => id !== newSessionId);
  sessions.unshift(newSessionId);
  sessions = sessions.slice(0, MAX_MESSAGES_IN_STORAGE);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(sessions));
}
  </script>
</body>
</html>

