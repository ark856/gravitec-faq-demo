<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gravi-Tec Chat Demo</title>
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Source Sans Pro', sans-serif;
      background: #0f1316;
      color: #eee;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    /* Darkened overlay */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }

    /* Chat modal */
    .chat-container {
		width: 600px;
		background: #1b1f24;
		border: 3px solid #000;
		display: flex;
		flex-direction: column;
		height: 600px; /* Bleibt bei 600px */
		box-shadow: 0 0 20px rgba(0, 0, 0, 0.6);
		color: #ddd;
	}

    .chat-header {
      background: linear-gradient(180deg, #3b75c3, #2858a8);
      color: white;
      font-weight: 700;
      padding: 14px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.12);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Chat messages container (Gesamtverlauf) */
	.chat-messages {
	    flex: 1;
	    padding: 20px;
	    overflow-y: auto; /* Bleibt bei auto */
	    /* ... restliche Styles ... */
	}
	
	/* Einzelne Nachricht */
	.message {
	    display: inline-block;
	    max-width: 95%;
	    /* NEU: Maximale HÃ¶he definieren, um den Container nicht zu Ã¼berdehnen */
	    /*max-height: 400px; */
	    /* NEU: Scrollen, falls die Nachricht die max-height Ã¼berschreitet */
	    /* overflow-y: auto; */
	    
	    background: #232933;
	    color: #f0f0f0;
	    padding: 10px 14px;
		margin 3px;
	    border-radius: 8px;
	    /*transform: skewX(-3deg);*/
	    /* overflow: hidden; (wird durch overflow-y ersetzt) */
	    word-wrap: break-word;
	    line-height: 1.4;
	}
	
	/* Der innere <span> */
	.message span {
	    display: inline-block;
		margin 0;
	    /*transform: skewX(3deg);*/
	    /*white-space: pre-wrap;*/
	    /* Wichtig: Um das Scrollen zu ermÃ¶glichen, muss der Inhalt, der scrollen soll, die HÃ¶he des Containers Ã¼berschreiten. 
	       Keine Ã„nderungen hier notwendig, da der Inhalt sich der message-Box anpasst. */
	}

    .message p {
		margin: 0;
		padding: 0;
	}

    .bot {
      background: #232933;
      align-self: flex-start;
      color: #f0f0f0;
    }

    .user {
      background: #2858a8;
      color: #fff;
      align-self: flex-end;
    }

    .chat-input {
      display: flex;
      border-top: 1px solid #333;
      background: #1b1f24;
      padding: 12px;
      gap: 10px;
    }

    .chat-input input {
      flex: 1;
      border: none;
      padding: 12px;
      font-size: 15px;
      border-radius: 6px;
      outline: none;
      background: #0f1316;
      color: #fff;
    }

    /* Imported button style */
    .btn-schild {
      position: relative;
      display: inline-block;
      transform: skewX(-12deg);
      border-radius: 10px;
      background: linear-gradient(180deg, #3b75c3, #2858a8);
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: 0 8px 24px rgba(0,0,0,0.5), 0 0 12px rgba(40,88,168,0.4);
      overflow: hidden;
      min-width: 140px;
	  padding-right: 20px;
    }
    .btn-schild > a {
      display: block;
      padding: 14px 54px 14px 28px;
      transform: skewX(12deg);
      color: white;
      text-decoration: none;
      font-weight: 700;
      font-size: 16px;
      position: relative;
      z-index: 1;
      text-align: center;
    }
    .btn-schild .chip {
      position: absolute;
      right: 6px;
      top: 6px;
      bottom: 6px;
      width: 46px;
      transform: skewX(-12deg);
      border-radius: 8px;
      background: linear-gradient(180deg, #fff, #f4f7fc);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      border: 1px solid rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn-schild .chip span {
      display: inline-block;
      transform: skewX(12deg);
      font-size: 18px;
      color: #2858a8;
      font-weight: 900;
    }

    /* Button hover */
    .btn-schild:hover {
      background: linear-gradient(180deg, #3b75c3, #3b75c3);
      box-shadow: 0 10px 30px rgba(0,0,0,0.5), 0 0 16px rgba(40,88,168,0.4);
    }

    /* Typing animation */
    .typing {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 10px 14px;
      border-radius: 12px;
      background: #232933;
      align-self: flex-start;
      transform: skewX(-12deg);
    }
    .typing span {
      transform: skewX(12deg);
      display: flex;
      gap: 4px;
    }
    .dot {
      width: 8px;
      height: 8px;
      background: #3b75c3;
      border-radius: 50%;
      animation: bounce 1s infinite;
    }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    /* Open button */
    .open-chat-btn {
      background: linear-gradient(180deg, #3b75c3, #2858a8);
      color: white;
      padding: 14px 30px;
      border: none;
      cursor: pointer;
      font-weight: 700;
      font-size: 16px;
      border-radius: 4px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <button class="open-chat-btn" onclick="openChat()">Chat Ã¶ffnen</button>

  <div class="modal-overlay" id="chatModal">
    <div class="chat-container">
      <div class="chat-header">Gravi-Tec Support Chat</div>
      <div class="chat-messages" id="chat"></div>
      <div class="chat-input">
        <input id="input" type="text" placeholder="Nachricht eingeben..."/>
        <div class="btn-schild" onclick="sendMessage()">
          <a href="#">Senden</a>
          <div class="chip"><span>âœŽ</span></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/lib/marked.umd.js"></script>
  <script>
    const chatModal = document.getElementById('chatModal');
    const chat = document.getElementById('chat');
    const input = document.getElementById('input');
    let messages = [];
    let typingIndicator = null;
    let greeted = false;

    function openChat() {
      chatModal.style.display = 'flex';
      if (!greeted) {
        addMessage('assistant', 'ðŸ‘‹ Hallo! Ich bin Ihr Gravi-Tec Berater. Wie kann ich Ihnen heute helfen?');
        greeted = true;
      }
    }

    function addMessage(role, content) {
      messages.push({ role, content });
      const msgDiv = document.createElement('div');
      msgDiv.className = 'message ' + (role === 'user' ? 'user' : 'bot');
      const inner = document.createElement('span');

      // NEU: Behandeln von escaped Newline-Zeichen, Tabs und escaped Leerzeichen
      let formattedContent = content
        .replace(/\\n/g, '\n') // Ersetzt explizite '\n' und '\\n' durch <br>
        //.replace(/\n/g, '<br>') // Ersetzt normale \n (falls sie aus der API kommen)
        .replace(/\\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;') // Ersetzt \t durch 4 non-breaking spaces
        .replace(/\\ /g, ' '); // Ersetzt escaped spaces '\ ' durch normale spaces

      // ACHTUNG: Verwenden Sie innerHTML, um die <br> und &nbsp; Tags zu rendern
      let noMarkdownContent = marked.parse(formattedContent);
	  inner.innerHTML = noMarkdownContent;

      msgDiv.appendChild(inner);
      chat.appendChild(msgDiv);
      chat.scrollTop = chat.scrollHeight;
    }

    function showTyping() {
      typingIndicator = document.createElement('div');
      typingIndicator.className = 'typing';
      const inner = document.createElement('span');
      inner.innerHTML = `<div class="dot"></div><div class="dot"></div><div class="dot"></div>`;
      typingIndicator.appendChild(inner);
      chat.appendChild(typingIndicator);
      chat.scrollTop = chat.scrollHeight;
    }

    function removeTyping() {
      if (typingIndicator) {
        chat.removeChild(typingIndicator);
        typingIndicator = null;
      }
    }

    async function sendMessage(){ 
		const text = input.value.trim(); 
		if (!text) 
			return; 
		addMessage('user', text); 
		input.value = ''; 
		showTyping(); // show spinner 
		try { 
			//const res = await fetch('http://localhost:8000/api/v1/chat', { 
			const res = await fetch('https://gravitec-faq-demo-backend.onrender.com/api/v1/chat', {
			method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ messages }) });
			
			const data = await res.json(); 
			removeTyping(); 
			if (data.message && data.message.role==='assistant'){ 
				addMessage('assistant', data.message.content); 
			} else { 
				addMessage('assistant', 'Fehler: UngÃ¼ltige Antwort vom Server.'); 
			} 
		} catch(e){ 
			removeTyping(); 
			addMessage('assistant', 'Fehler beim Senden der Nachricht.'); 
		} 
	} 
	
	input.addEventListener('keypress', e => { if(e.key === 'Enter') sendMessage(); });
	
  </script>
</body>
</html>




